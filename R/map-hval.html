<!DOCTYPE html>
<html>
<title>Choropleth Maps in R</title>

<head>
  <meta charset="UTF-8">

  <link rel="stylesheet" href="/css/w3.css">
  <link rel="stylesheet" href="/css/w3-theme-teal.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/my.css">

  <link rel="stylesheet" href="/css/shCore.css" />
  <link rel="stylesheet" href="/css/shThemeDefault.css" />

  <script type="text/javascript" src="/js/shCore.js"></script>
  <script type="text/javascript" src="/js/shBrushPython.js"></script>
  <script type="text/javascript" src="/js/shBrushJScript.js"></script>
</head>

<body>

<!-- Title -->
<div class="w3-bar w3-theme w3-xlarge">
  <a href="#" class="w3-bar-item w3-button w3-hover-none my-hover-text"><i class="fa fa-bars"></i></a>
  <a href="#" class="w3-bar-item w3-button w3-hover-none my-hover-text">Maps</a>
  <a href="/" class="w3-bar-item w3-button w3-hover-none my-hover-text w3-right"><i class="fa fa-home"></i></a>
</div>

<!--Content -->
<div class="w3-container w3-white">

<h1>Choropleth Maps in R</h1>

<p>
A choropleth map is a thematic map in which areas are colored in relation to a data variable being displayed on the map, 
such as population density.
In this tutorial we will display median home value per square foot in the state of New Jersey.
The final map will look like this:
</p>

<img src="img/nj-hval.png">

<h2>Data</h2>

<p>
We will need two pieces of data:
</p>

<ul>
<li>Geographic data to draw the map of New Jersey.</li>
<li>Median home values.</li>
</ul>

<h3>Cartographic Boundary Shapefiles</h3>

<p>
The shapefile format is a popular geospatial vector data format for geographic information systems (GIS).
It is developed and regulated by Esri (Environmental Systems Research Institute).
</p>

<p>
You can download free shapefiles from <a href="https://www.census.gov/">census.gov</a> web site. 
I chose the national county file <a href="http://www2.census.gov/geo/tiger/GENZ2017/shp/cb_2017_us_county_5m.zip">cb_2017_us_county_5m.zip</a>
containing state and county data. The zip file contains multiple files. Extract them in some directory, such as, <i>/data/cb_2017_us_county_5m/</i>.
</p>

<h3>Median Home Values</h3>

<p>
You can get this information from <a href="https://www.zillow.com/research/data/">Zillow Research</a> web site.
I downloaded the following CSV file, <i>County_MedianValuePerSqft_AllHomes.csv</i>.
</p>


<h2>The Map of New Jersey</h2>

<p>
To read a shapefile and draw a map we will need following libraries.
Make sure they are properly installed on your system.
</p>

<script type="syntaxhighlighter" class="brush: py"><![CDATA[
library(sf)
library(tmap)
library(tmaptools)
]]></script>

<p>
Let us load national county shapefile, extract New Jersey data and draw the map.
</p>

<script type="syntaxhighlighter" class="brush: py"><![CDATA[
sf_us = st_read("/data/cb_2017_us_county_5m")
sf_nj = sf_us[sf_us$STATEFP==34, c("NAME","geometry")]
colnames(sf_nj) = c("County", "geometry")
qtm(sf_nj)
]]></script>

<p>
The map should look like this:
</p>

<img src="img/nj.png" height="500px">

<p>
We used sf library to load national county shapefile from <i>/data/cb_2017_us_county_5m/</i> folder into <i>sf_us</i> variable.
The structure of <i>sf_us</i> variable is similar to a conventional data frame. It contains data for all states.
</p>

<p>
The state information is stored in &quot;STATEFP&quot; column as 
a <a href="https://www.census.gov/geo/reference/ansi_statetables.html">FIPS code</a>.
The FIPS code for New Jersey is 34. County names are stored in &quot;NAME&quot; column and geodata is stored 
in &quot;geometry&quot; column.
</p>

<p>
Extracting geodata for New Jersey is similar to subsetting any other type of data in R.
We selected two columns, &quot;NAME&quot; and &quot;geometry&quot; and all rows with FIPS code 34. 
We also renamed &quot;NAME&quot; column to &quot;County&quot;.
</p>

<p>
Finally we used qtm() API from tmap library to create the map.
</p>


<h2>Median Home Values</h2>

<p>
First, let us read CSV file and extract data for New Jersey. The file contains historical data for all states.
We will extract only two columns, &quot;RegionName&quot; with county names and &quot;X2018.07&quot; 
which has median home values in July 2018. We will also rename &quot;RegionName&quot; to &quot;County&quot; and
&quot;X2018.07&quot; to &quot;MedianVal&quot;
</p>

<script type="syntaxhighlighter" class="brush: py"><![CDATA[
hval = read.csv("/data/County_MedianValuePerSqft_AllHomes.csv")
hval_nj = hval[hval$State=="NJ", c("RegionName", "X2018.07")]
colnames(hval_nj) = c("County", "MedianVal")
]]></script>

<p>
Now we have to merge data from two datasets, sf_nj and hval_nj by key &quot;County&quot;. 
We will use append_data() API from tmaptools library.
This operation is similar to a join of two database tables.
</p>

<script type="syntaxhighlighter" class="brush: py"><![CDATA[
all_nj = append_data(sf_nj, hval_nj, key.shp="County", key.data="County")
]]></script>

<p>
Now we can create a simple choropleth map.
</p>

<script type="syntaxhighlighter" class="brush: py"><![CDATA[
qtm(all_nj, fill="MedianVal")
]]></script>

<p>
The map should look like this.
</p>

<img src="img/nj-hval2.png" height="500px">

<p>
Finally, let us add county names and customize colors.
</p>

<script type="syntaxhighlighter" class="brush: py"><![CDATA[
colors = c("#ffffd4","#fee391","#fec44f","#fe9929","#ec7014")

qtm(all_nj, fill="MedianVal", fill.title="Median Value", fill.palette=colors) 
    + tm_text("County", col=c("black"))
]]></script>

<p>
Now the map should look like this:
</p>

<img src="img/nj-hval.png">

</div>

<!-- Syntax highlighting -->
<script>
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all()
</script>

</body>

</html>


